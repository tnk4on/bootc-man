name: E2E Tests

on:
  workflow_dispatch:
    inputs:
      run_linux:
        description: 'Run Linux E2E tests'
        required: false
        default: 'true'
        type: boolean
      run_kvm_verify:
        description: 'Run KVM + QEMU verification'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read

env:
  GO_VERSION: '1.24'

jobs:
  # ============================================================
  # Job 1: Verify KVM + QEMU on GitHub-hosted runner
  # Pure infrastructure check — no bootc-man dependency
  # ============================================================
  verify-kvm:
    name: Verify KVM + QEMU
    runs-on: ubuntu-latest
    if: github.event.inputs.run_kvm_verify == 'true'
    timeout-minutes: 10
    steps:
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Verify KVM availability
        run: |
          ls -la /dev/kvm
          grep -cE '(vmx|svm)' /proc/cpuinfo
          lsmod | grep kvm

      - name: Install QEMU and OVMF
        run: |
          sudo rm -f /etc/apt/sources.list.d/microsoft-prod.list /etc/apt/sources.list.d/azure-cli.list
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 qemu-utils ovmf

      - name: Verify QEMU and OVMF
        run: |
          qemu-system-x86_64 --version
          ls /usr/share/OVMF/OVMF_CODE*.fd

      - name: Test QEMU+KVM acceleration
        run: |
          echo "Testing QEMU with KVM acceleration..."
          timeout 5 qemu-system-x86_64 \
            -machine accel=kvm \
            -cpu host \
            -m 256 \
            -nographic \
            -no-reboot \
            -display none \
            -serial none \
            -monitor none 2>&1 || EXIT_CODE=$?
          # Exit code 124 (timeout) or 1 (no disk) is expected
          if [ "${EXIT_CODE:-0}" -eq 124 ] || [ "${EXIT_CODE:-0}" -le 1 ]; then
            echo "✅ QEMU+KVM acceleration works"
          else
            echo "❌ QEMU+KVM not working (exit code: ${EXIT_CODE})"
            exit 1
          fi

  # ============================================================
  # Job 2: Full E2E Tests (Linux) with VM boot
  # Runs all E2E tests including container builds and VM boot
  # Requires: KVM, QEMU, OVMF, gvproxy, Podman, SSH keys
  # Note: macOS tests are not run on GitHub Actions due to
  #   Podman Machine limitations (no nested virtualization).
  #   Consider Cirrus CI for macOS E2E testing.
  # ============================================================
  e2e-full-linux:
    name: E2E Full (Linux)
    runs-on: ubuntu-latest
    if: github.event.inputs.run_linux == 'true'
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      # KVM setup (required for QEMU acceleration)
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      # Install system dependencies
      - name: Install dependencies
        run: |
          sudo rm -f /etc/apt/sources.list.d/microsoft-prod.list /etc/apt/sources.list.d/azure-cli.list
          sudo apt-get update
          sudo apt-get install -y \
            podman \
            qemu-system-x86 \
            qemu-utils \
            ovmf

      # Build gvproxy from source (not available as Ubuntu binary package)
      - name: Install gvproxy
        run: |
          go install github.com/containers/gvisor-tap-vsock/cmd/gvproxy@latest
          which gvproxy
          echo "gvproxy installed at: $(which gvproxy)"

      # Generate SSH key pair for VM access (CI doesn't have one by default)
      - name: Generate SSH key pair
        run: |
          mkdir -p ~/.ssh
          ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N "" -C "bootc-man-ci"
          chmod 600 ~/.ssh/id_ed25519
          chmod 644 ~/.ssh/id_ed25519.pub
          echo "SSH key pair generated"

      - name: Verify environment
        run: |
          echo "=== KVM ==="
          ls -la /dev/kvm
          echo ""
          echo "=== QEMU ==="
          qemu-system-x86_64 --version
          echo ""
          echo "=== OVMF ==="
          ls /usr/share/OVMF/OVMF_CODE*.fd 2>/dev/null || ls /usr/share/edk2/ovmf/OVMF_CODE*.fd 2>/dev/null || echo "OVMF not found"
          echo ""
          echo "=== Podman ==="
          podman version
          echo ""
          echo "=== gvproxy ==="
          which gvproxy && gvproxy --help 2>&1 | head -3 || echo "gvproxy not found"
          echo ""
          echo "=== SSH key ==="
          ls -la ~/.ssh/id_ed25519 ~/.ssh/id_ed25519.pub

      - name: Build bootc-man
        run: make build

      - name: Verify bootc-man
        run: ./bin/bootc-man version

      # Free disk space - raw disk images are ~10GB
      - name: Free disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h /
          # Remove unnecessary large packages to free disk space
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost 2>/dev/null || true
          sudo apt-get clean 2>/dev/null || true
          echo "=== Disk space after cleanup ==="
          df -h /

      # Run non-VM E2E tests first (registry, build, CI pipeline tests)
      # Go's regexp doesn't support negative lookahead, so we use explicit patterns
      # Note: Bootc tests (Upgrade/Switch/Rollback) require a running VM,
      # so they run in the VM test step below.
      - name: Run non-VM E2E tests
        run: |
          set -o pipefail
          go test -v -tags=e2e -timeout=30m \
            -run '^Test(Container|Registry|CI|E2E|Podman)' \
            -count=1 ./test/e2e/... 2>&1 | tee e2e-results-non-vm.txt
        env:
          CI: "true"
          GITHUB_ACTIONS: "true"

      # Clean up containers/images from non-VM tests to free disk and memory
      - name: Free resources before VM tests
        if: always()
        run: |
          podman system prune -af 2>/dev/null || true
          sudo podman system prune -af 2>/dev/null || true
          echo "=== Disk space before VM tests ==="
          df -h /

      # Phase 1: Boot VM (TestVMBoot, TestVMSSHConnection, etc.)
      # Go runs tests alphabetically by file, so we must run VM boot separately
      # before Bootc tests that depend on a running VM.
      - name: Run VM boot tests
        run: |
          set -o pipefail
          go test -v -tags=e2e -timeout=30m \
            -run '^TestVM(Boot|SSHConnection|InfrastructureAvailability|List|Status)' \
            -count=1 ./test/e2e/... 2>&1 | tee e2e-results-vm.txt
        env:
          CI: "true"
          GITHUB_ACTIONS: "true"

      # Phase 2: Bootc tests (Upgrade/Switch/Rollback) require a running VM
      - name: Run Bootc tests
        run: |
          set -o pipefail
          go test -v -tags=e2e -timeout=30m \
            -run '^TestBootc(Status|StatusJSON|Upgrade|Switch|Rollback)' \
            -count=1 ./test/e2e/... 2>&1 | tee e2e-results-bootc.txt
        env:
          CI: "true"
          GITHUB_ACTIONS: "true"

      # Phase 3: VM cleanup
      - name: Run VM cleanup tests
        if: always()
        run: |
          go test -v -tags=e2e -timeout=5m \
            -run '^TestVMCleanup' \
            -count=1 ./test/e2e/... 2>&1 | tee e2e-results-vm-cleanup.txt || true
        env:
          CI: "true"
          GITHUB_ACTIONS: "true"

      # Merge test results
      - name: Merge test results
        if: always()
        run: |
          cat e2e-results-non-vm.txt e2e-results-vm.txt e2e-results-bootc.txt e2e-results-vm-cleanup.txt > e2e-results.txt 2>/dev/null || true

      - name: Test summary
        if: always()
        run: |
          echo "## E2E Full Test Results (Linux)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f e2e-results.txt ]; then
            PASS=$(grep -c "^--- PASS" e2e-results.txt || true)
            FAIL=$(grep -c "^--- FAIL" e2e-results.txt || true)
            SKIP=$(grep -c "^--- SKIP" e2e-results.txt || true)
            echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| PASS | $PASS |" >> $GITHUB_STEP_SUMMARY
            echo "| FAIL | $FAIL |" >> $GITHUB_STEP_SUMMARY
            echo "| SKIP | $SKIP |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "$FAIL" -gt 0 ]; then
              echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep "^--- FAIL" e2e-results.txt >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          fi

      # Collect VM-related logs for debugging
      - name: Collect VM logs
        if: always()
        run: |
          mkdir -p /tmp/vm-logs
          cp /tmp/bootc-man-qemu-*.log /tmp/vm-logs/ 2>/dev/null || true
          cp /tmp/bootc-man-gvproxy-*.log /tmp/vm-logs/ 2>/dev/null || true
          ls -la /tmp/vm-logs/ 2>/dev/null || echo "No VM logs found"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-full-linux-results
          path: |
            e2e-results.txt
            test/e2e/*.log
            test/e2e/tmp/
            /tmp/vm-logs/
          retention-days: 14
